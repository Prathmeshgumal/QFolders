{% extends "base.html" %}
{% block content %}
<div class="d-flex align-items-center justify-content-between mb-4">
  <h1 class="h3 mb-0" style="color: var(--netflix-white); font-weight: 700;">{{ question['title'] }}</h1>
  <div class="d-flex align-items-center gap-2">
    <button type="button" class="btn btn-outline-danger btn-sm" 
            onclick="confirmDeleteQuestion('{{ question['id'] }}', '{{ question['title'] }}')"
            title="Delete question">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="3,6 5,6 21,6"></polyline>
        <path d="m19,6v14a2,2 0 0,1 -2,2H7a2,2 0 0,1 -2,-2V6m3,0V4a2,2 0 0,1 2,-2h4a2,2 0 0,1 2,2v2"></path>
        <line x1="10" y1="11" x2="10" y2="17"></line>
        <line x1="14" y1="11" x2="14" y2="17"></line>
      </svg>
      Delete
    </button>
    {% if folder %}
      <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary btn-sm" style="font-weight: 500;">‚Üê Back to Dashboard</a>
    {% endif %}
  </div>
</div>

<form method="post" action="{{ url_for('update_question', question_id=question['id']) }}" enctype="multipart/form-data">
<div class="row g-4">
  <div class="col-12 col-lg-6">
    <div class="card mb-3">
      <div class="card-body">
        <input type="text" name="title" class="form-control" value="{{ question['title'] }}" required style="background: var(--netflix-gray); border: 1px solid var(--netflix-border); color: var(--netflix-white); padding: 12px; border-radius: 6px; font-size: 1.05rem; font-weight: 600;">
      </div>
    </div>

    <div class="card mb-3">
      <div class="card-body">
        <h2 class="h6 mb-3" style="color: var(--netflix-white); font-weight: 600;">Que description</h2>
        <textarea name="description" class="form-control" rows="4" style="background: var(--netflix-gray); border: 1px solid var(--netflix-border); color: var(--netflix-white); padding: 12px; border-radius: 6px; font-size: 1rem; line-height: 1.6; min-height: 100px;">{{ question['description'] or '' }}</textarea>
      </div>
    </div>

    <div class="card mb-3">
      <div class="card-body">
        <h2 class="h6 mb-3" style="color: var(--netflix-white); font-weight: 600;">PDF File</h2>
        <div style="background: var(--netflix-gray); padding: 8px; border-radius: 6px; border: 1px solid var(--netflix-border);">
          <div class="d-flex align-items-center justify-content-between">
            <div class="d-flex align-items-center" style="flex: 1;">
              {% if question.get('pdf_file_name') %}
                <span style="color: var(--netflix-white); font-size: 0.9rem; margin-right: 8px;">üìÑ {{ question['pdf_file_name'] }}</span>
                <small style="color: var(--netflix-light-gray); font-size: 0.75rem;">{{ (question.get('pdf_file_size', 0) / 1024 / 1024) | round(2) }}MB</small>
              {% else %}
                <span style="color: var(--netflix-light-gray); font-size: 0.9rem;">No PDF attached</span>
              {% endif %}
            </div>
            <div class="d-flex align-items-center gap-1">
              {% if question.get('pdf_file_name') %}
                <button type="button" class="btn btn-outline-success" onclick="togglePDFViewer()" id="viewerToggleBtn" style="padding: 4px 6px; font-size: 0.75rem; border-radius: 4px;">
                  <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                    <circle cx="12" cy="12" r="3"></circle>
                  </svg>
                </button>
                <a href="{{ url_for('download_pdf', question_id=question['id']) }}" class="btn btn-outline-success" target="_blank" style="padding: 4px 6px; font-size: 0.75rem; border-radius: 4px;">
                  <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="7,10 12,15 17,10"></polyline>
                    <line x1="12" y1="15" x2="12" y2="3"></line>
                  </svg>
                </a>
              {% endif %}
              <label for="pdf_file_input" class="btn btn-outline-success" style="padding: 4px 6px; font-size: 0.75rem; border-radius: 4px; margin: 0; cursor: pointer;">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                  <polyline points="14,2 14,8 20,8"></polyline>
                  <line x1="16" y1="13" x2="8" y2="13"></line>
                  <line x1="16" y1="17" x2="8" y2="17"></line>
                  <polyline points="10,9 9,9 8,9"></polyline>
                </svg>
              </label>
              <input type="file" id="pdf_file_input" name="pdf_file" accept=".pdf" style="display: none;" />
            </div>
          </div>
          {% if question.get('pdf_file_name') %}
            <div id="pdfViewer" style="display: none; height: 600px; background: white; margin-top: 8px; border-radius: 4px; overflow: hidden;">
              <iframe 
                src="{{ url_for('view_pdf', question_id=question['id']) }}" 
                width="100%" 
                height="100%" 
                style="border: none;"
                title="PDF Viewer">
              </iframe>
            </div>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="card mb-3">
      <div class="card-body">
        <h2 class="h6 mb-3" style="color: var(--netflix-white); font-weight: 600;">Links (one per line)</h2>
        <textarea name="links" class="form-control" rows="4" style="background: var(--netflix-gray); border: 1px solid var(--netflix-border); color: var(--netflix-white); padding: 12px; border-radius: 6px; font-size: 1rem; line-height: 1.6; min-height: 100px;">{% if question['links'] %}{{ question['links'] | join('\n') }}{% endif %}</textarea>
      </div>
    </div>

    <div class="card">
      <div class="card-body">
        <h2 class="h6 mb-3" style="color: var(--netflix-white); font-weight: 600;">Notes</h2>
        <textarea name="notes" class="form-control" rows="4" style="background: var(--netflix-gray); border: 1px solid var(--netflix-border); color: var(--netflix-white); padding: 12px; border-radius: 6px; font-size: 1rem; line-height: 1.6; min-height: 100px;">{{ question['notes'] or '' }}</textarea>
      </div>
    </div>
  </div>

  <div class="col-12 col-lg-6">
    <div class="card mb-3">
      <div class="card-body">
        <h2 class="h6 mb-3" style="color: var(--netflix-white); font-weight: 600;">Code section</h2>
        {% if question['code'] %}
          <div class="code-editor-container" style="background: #1e1e1e; border-radius: 8px; border: 1px solid #333; overflow: hidden; min-height: 400px;">
            <div class="code-editor-header" style="background: #2d2d30; padding: 8px 16px; border-bottom: 1px solid #333; display: flex; align-items: center; justify-content-between;">
              <div style="display: flex; align-items: center;">
                <div style="width: 12px; height: 12px; background: #ff5f56; border-radius: 50%; margin-right: 8px;"></div>
                <div style="width: 12px; height: 12px; background: #ffbd2e; border-radius: 50%; margin-right: 8px;"></div>
                <div style="width: 12px; height: 12px; background: #27ca3f; border-radius: 50%; margin-right: 16px;"></div>
                <span style="color: #cccccc; font-size: 0.85rem; font-family: 'Segoe UI', sans-serif;">main.cpp</span>
              </div>
              <div style="color: #888; font-size: 0.8rem; font-family: 'Segoe UI', sans-serif;">C++</div>
            </div>
            <div class="code-editor-content" style="position: relative; overflow-x: auto;">
              <div class="code-editor-lines" style="display: flex; font-family: 'Fira Code', 'Consolas', 'Monaco', 'Courier New', monospace; font-size: 0.9rem; line-height: 1.5;">
                <div class="line-numbers" style="background: #252526; color: #858585; padding: 16px 8px 16px 16px; border-right: 1px solid #333; user-select: none; min-width: 50px; text-align: right;">
                  {% set code_lines = question['code'].split('\n') %}
                  {% for i in range(1, code_lines|length + 1) %}
                    <div style="height: 1.5em;">{{ i }}</div>
                  {% endfor %}
                </div>
                <div class="code-content" style="flex: 1; padding: 16px; color: #d4d4d4; background: #1e1e1e;">
                  <textarea name="code" style="margin: 0; width: 100%; height: 100%; background: transparent; border: none; color: #d4d4d4; font-family: 'Fira Code', 'Consolas', 'Monaco', 'Courier New', monospace; font-size: 0.9rem; line-height: 1.5; letter-spacing: 0.5px; resize: none; outline: none;">{{ question['code'] or '' }}</textarea>
                </div>
              </div>
            </div>
          </div>
        {% else %}
          <div class="code-editor-container" style="background: #1e1e1e; border-radius: 8px; border: 1px solid #333; overflow: hidden; min-height: 400px;">
            <div class="code-editor-header" style="background: #2d2d30; padding: 8px 16px; border-bottom: 1px solid #333; display: flex; align-items: center; justify-content-between;">
              <div style="display: flex; align-items: center;">
                <div style="width: 12px; height: 12px; background: #ff5f56; border-radius: 50%; margin-right: 8px;"></div>
                <div style="width: 12px; height: 12px; background: #ffbd2e; border-radius: 50%; margin-right: 8px;"></div>
                <div style="width: 12px; height: 12px; background: #27ca3f; border-radius: 50%; margin-right: 16px;"></div>
                <span style="color: #cccccc; font-size: 0.85rem; font-family: 'Segoe UI', sans-serif;">main.cpp</span>
              </div>
              <div style="color: #888; font-size: 0.8rem; font-family: 'Segoe UI', sans-serif;">C++</div>
            </div>
            <div class="code-editor-content" style="position: relative; overflow-x: auto;">
              <div class="code-editor-lines" style="display: flex; font-family: 'Fira Code', 'Consolas', 'Monaco', 'Courier New', monospace; font-size: 0.9rem; line-height: 1.5;">
                <div class="line-numbers" style="background: #252526; color: #858585; padding: 16px 8px 16px 16px; border-right: 1px solid #333; user-select: none; min-width: 50px; text-align: right;">
                  <div style="height: 1.5em;">1</div>
                </div>
                <div class="code-content" style="flex: 1; padding: 16px; color: #d4d4d4; background: #1e1e1e;">
                  <textarea name="code" placeholder="Click here to add code..." style="margin: 0; width: 100%; height: 100%; background: transparent; border: none; color: #d4d4d4; font-family: 'Fira Code', 'Consolas', 'Monaco', 'Courier New', monospace; font-size: 0.9rem; line-height: 1.5; letter-spacing: 0.5px; resize: none; outline: none; min-height: 350px;">{{ question['code'] or '' }}</textarea>
                </div>
              </div>
            </div>
          </div>
        {% endif %}
      </div>
    </div>
    
    <div class="card">
      <div class="card-body">
        <h2 class="h6 mb-3" style="color: var(--netflix-white); font-weight: 600;">Terminal</h2>
        <div class="terminal-section">
          <div class="terminal-header">
            <div style="display: flex; align-items: center;">
              <div style="width: 12px; height: 12px; background: #ff5f56; border-radius: 50%; margin-right: 8px;"></div>
              <div style="width: 12px; height: 12px; background: #ffbd2e; border-radius: 50%; margin-right: 8px;"></div>
              <div style="width: 12px; height: 12px; background: #27ca3f; border-radius: 50%; margin-right: 16px;"></div>
              <span>Terminal</span>
            </div>
          </div>
          <div class="terminal-content">
            <div style="color: #00ff00; font-size: 0.9rem; margin-bottom: 8px;">$</div>
            <textarea name="terminal_output" placeholder="Click here to add terminal output..." style="width: 100%; height: 100%; background: transparent; border: none; color: #d4d4d4; font-family: 'Fira Code', 'Consolas', 'Monaco', 'Courier New', monospace; font-size: 0.9rem; line-height: 1.5; letter-spacing: 0.5px; resize: none; outline: none; min-height: 200px;">{{ question.get('terminal_output') or '' }}</textarea>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="row mt-4">
  <div class="col-12">
    <div class="d-flex justify-content-end gap-2">
      <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary">Cancel</a>
      <button type="submit" class="btn btn-success">Save Changes</button>
    </div>
  </div>
</div>
</form>
<style>
/* Code Editor Syntax Highlighting */
.code-content pre {
  color: #d4d4d4 !important;
  letter-spacing: 1.5 px !important;
}

/* Basic C++ syntax highlighting */
.code-content pre {
  /* Keywords */
  background: linear-gradient(90deg, 
    transparent 0%, 
    transparent 100%
  );
}

/* Add some basic syntax highlighting using CSS */
.code-content pre:has-text("#include") {
  color: #569cd6; /* Blue for includes */
}

/* Line number styling */
.line-numbers div {
  font-size: 0.9rem;
  line-height: 1.5;
  color: #858585;
}

/* Code editor container hover effect */
.code-editor-container:hover {
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
  transition: box-shadow 0.3s ease;
}

/* Terminal section styling to match */
.terminal-section {
  background: #1e1e1e;
  border-radius: 8px;
  border: 1px solid #333;
  overflow: hidden;
}

.terminal-header {
  background: #2d2d30;
  padding: 8px 16px;
  border-bottom: 1px solid #333;
  color: #cccccc;
  font-size: 0.85rem;
  font-family: 'Segoe UI', sans-serif;
}

.terminal-content {
  background: #1e1e1e;
  padding: 16px;
  color: #d4d4d4;
  font-family: 'Fira Code', 'Consolas', 'Monaco', 'Courier New', monospace;
  font-size: 0.9rem;
  line-height: 1.5;
  letter-spacing: 0.5px;
  min-height: 200px;
}

/* Placeholder styling for better visibility */
textarea::placeholder {
  color: #666 !important;
  font-style: italic;
  opacity: 0.8;
}

/* Hover effects for empty sections */
.code-editor-container:hover {
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
  transition: box-shadow 0.3s ease;
}

.terminal-section:hover {
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
  transition: box-shadow 0.3s ease;
}

/* Focus styles for better UX */
textarea:focus {
  outline: 2px solid #007bff !important;
  outline-offset: 2px;
}
</style>

<script>
function togglePDFViewer() {
  const viewer = document.getElementById('pdfViewer');
  const button = document.getElementById('viewerToggleBtn');
  
  if (viewer.style.display === 'none' || viewer.style.display === '') {
    viewer.style.display = 'block';
    button.innerHTML = `
      <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path>
        <line x1="1" y1="1" x2="23" y2="23"></line>
      </svg>
    `;
  } else {
    viewer.style.display = 'none';
    button.innerHTML = `
      <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
        <circle cx="12" cy="12" r="3"></circle>
      </svg>
    `;
  }
}

// Auto-save functionality for question content
function autoSaveContent(field, value) {
  const questionId = '{{ question["id"] }}';
  
  fetch('/api/autosave/content', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      question_id: questionId,
      field: field,
      value: value
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      console.log(`${field} auto-saved successfully`);
      // Show a subtle save indicator
      showSaveIndicator();
    } else {
      console.error('Auto-save failed:', data.error);
    }
  })
  .catch(error => {
    console.error('Auto-save error:', error);
  });
}

// Show save indicator
function showSaveIndicator() {
  // Create or update save indicator
  let indicator = document.getElementById('saveIndicator');
  if (!indicator) {
    indicator = document.createElement('div');
    indicator.id = 'saveIndicator';
    indicator.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      background: #28a745;
      color: white;
      padding: 8px 16px;
      border-radius: 4px;
      font-size: 14px;
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.3s ease;
    `;
    document.body.appendChild(indicator);
  }
  
  indicator.textContent = 'Saved';
  indicator.style.opacity = '1';
  
  // Hide after 2 seconds
  setTimeout(() => {
    indicator.style.opacity = '0';
  }, 2000);
}

// Debounce function to avoid too many API calls
function debounce(func, wait) {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}

// Create debounced auto-save function
const debouncedAutoSave = debounce(autoSaveContent, 1000);

// Add auto-save event listeners
document.addEventListener('DOMContentLoaded', function() {
  // Auto-save for title
  const titleInput = document.querySelector('input[name="title"]');
  if (titleInput) {
    titleInput.addEventListener('input', function() {
      debouncedAutoSave('title', this.value);
    });
  }
  
  // Auto-save for description
  const descriptionInput = document.querySelector('textarea[name="description"]');
  if (descriptionInput) {
    descriptionInput.addEventListener('input', function() {
      debouncedAutoSave('description', this.value);
    });
  }
  
  // Auto-save for links
  const linksInput = document.querySelector('textarea[name="links"]');
  if (linksInput) {
    linksInput.addEventListener('input', function() {
      debouncedAutoSave('links', this.value);
    });
  }
  
  // Auto-save for notes
  const notesInput = document.querySelector('textarea[name="notes"]');
  if (notesInput) {
    notesInput.addEventListener('input', function() {
      debouncedAutoSave('notes', this.value);
    });
  }
  
  // Auto-save for code
  const codeInput = document.querySelector('textarea[name="code"]');
  if (codeInput) {
    codeInput.addEventListener('input', function() {
      debouncedAutoSave('code', this.value);
    });
  }
  
  // Auto-save for terminal output
  const terminalInput = document.querySelector('textarea[name="terminal_output"]');
  if (terminalInput) {
    terminalInput.addEventListener('input', function() {
      debouncedAutoSave('terminal_output', this.value);
    });
  }
});
</script>

<!-- Delete Question Confirmation Modal -->
<div class="modal fade" id="deleteQuestionModal" tabindex="-1" aria-labelledby="deleteQuestionModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteQuestionModalLabel">Delete Question</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete the question "<span id="questionName"></span>"?</p>
        <p class="text-danger"><strong>Warning:</strong> This will permanently delete the question and any associated files. This action cannot be undone.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <form id="deleteQuestionForm" method="post" style="display: inline;">
          <button type="submit" class="btn btn-danger">Delete Question</button>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
function confirmDeleteQuestion(questionId, questionTitle) {
  document.getElementById('questionName').textContent = questionTitle;
  document.getElementById('deleteQuestionForm').action = '/questions/' + questionId + '/delete';
  
  var deleteQuestionModal = new bootstrap.Modal(document.getElementById('deleteQuestionModal'));
  deleteQuestionModal.show();
}
</script>
{% endblock %}
