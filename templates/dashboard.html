{% extends "base.html" %}
{% block content %}
<div class="row g-4">
  <div class="col-12 col-lg-4">
    <div class="card">
      <div class="card-body">
        <div class="d-flex align-items-center justify-content-between">
          <div>
            <h3 class="h6 mb-2" style="color: var(--netflix-white); font-weight: 600;">Total Progress</h3>
            <div class="h4 mb-0" style="color: var(--netflix-white); font-weight: 700;" id="progressText">0 / 0</div>
          </div>
          <div class="position-relative" style="width: 80px; height: 80px;">
            <svg class="progress-ring" width="80" height="80">
              <circle
                class="progress-ring-circle-bg"
                stroke="var(--netflix-gray)"
                stroke-width="6"
                fill="transparent"
                r="34"
                cx="40"
                cy="40"/>
              <circle
                class="progress-ring-circle"
                stroke="var(--netflix-red)"
                stroke-width="6"
                fill="transparent"
                r="34"
                cx="40"
                cy="40"
                id="progressCircle"/>
            </svg>
            <div class="position-absolute top-50 start-50 translate-middle text-center">
              <div class="h6 mb-0" style="color: var(--netflix-white); font-weight: 600;" id="progressPercentage">0%</div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Contribution Graph -->
    <div class="card mt-3">
      <div class="card-body">
        <h5 class="card-title mb-3" style="color: var(--netflix-white); font-weight: 600;">Your Activity</h5>
        <div id="contributionGraph" class="contribution-graph">
          <!-- Contribution graph will be loaded here -->
        </div>
        <div class="mt-3">
          <small class="text-muted">
            <span id="totalContributions">0</span> contributions in the last 6 months
          </small>
        </div>
      </div>
    </div>
  </div>

  <div class="col-12 col-lg-8">
    <div class="card">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h2 class="h5 mb-0">Your Folders</h2>
          <button type="button" class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#createFolderModal">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 6px;">
              <line x1="12" y1="5" x2="12" y2="19"></line>
              <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
            Create Folder
          </button>
        </div>
        {% if folders %}
          <div class="list-group">
            {% for f in folders %}
              <div class="list-group-item folder-item">
                <div class="d-flex align-items-center mb-2">
                  <button class="btn btn-outline-secondary btn-sm me-2 dropdown-toggle" 
                          type="button" 
                          data-bs-toggle="collapse" 
                          data-bs-target="#folder-{{ f['id'] }}" 
                          aria-expanded="false" 
                          aria-controls="folder-{{ f['id'] }}"
                          style="min-width: 40px;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <polyline points="6,9 12,15 18,9"></polyline>
                    </svg>
                  </button>
                  <a href="{{ url_for('folder_detail', folder_id=f['id']) }}" class="text-decoration-none flex-grow-1">
                    <span class="folder-name">{{ f['name'] }}</span>
                  </a>
                  <span class="checked-counter badge text-bg-success" 
                        id="counter-{{ f['id'] }}" 
                        style="font-size: 0.75rem; display: none; margin-right: 2rem;">
                    0/{{ f['questions']|length }}
                  </span>
                  <button type="button" class="btn btn-outline-success btn-sm delete-btn" 
                          onclick="confirmDeleteFolder('{{ f['id'] }}', '{{ f['name'] }}')"
                          title="Delete folder">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <polyline points="3,6 5,6 21,6"></polyline>
                      <path d="m19,6v14a2,2 0 0,1 -2,2H7a2,2 0 0,1 -2,-2V6m3,0V4a2,2 0 0,1 2,-2h4a2,2 0 0,1 2,2v2"></path>
                      <line x1="10" y1="11" x2="10" y2="17"></line>
                      <line x1="14" y1="11" x2="14" y2="17"></line>
                    </svg>
                  </button>
                </div>
                
                <div class="collapse" id="folder-{{ f['id'] }}">
                  <div class="folder-content">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                      <h6 class="mb-0" style="color: var(--netflix-light-gray);">Questions ({{ f['questions']|length }})</h6>
                      <button type="button" class="btn btn-success btn-sm" 
                              onclick="openAddQuestionModal('{{ f['id'] }}', '{{ f['name'] }}')">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 4px;">
                          <line x1="12" y1="5" x2="12" y2="19"></line>
                          <line x1="5" y1="12" x2="19" y2="12"></line>
                        </svg>
                        Add Question
                      </button>
                    </div>
                    
                    {% if f['questions'] %}
                      <div class="questions-list">
                        {% for q in f['questions'] %}
                          <div class="question-item">
                            <div class="d-flex align-items-center justify-content-between">
                              <div class="d-flex align-items-center">
                                <div class="form-check me-3">
                                  <input class="form-check-input question-checkbox" type="checkbox" 
                                         id="question-{{ q['id'] }}" 
                                         data-question-id="{{ q['id'] }}"
                                         data-folder-id="{{ f['id'] }}"
                                         {% if q.get('is_completed') %}checked{% endif %}>
                                  <label class="form-check-label" for="question-{{ q['id'] }}"></label>
                                </div>
                                <a href="{{ url_for('question_detail', question_id=q['id']) }}" class="text-decoration-none">
                                  <div>
                                    <h6 class="mb-0" style="color: var(--netflix-white); font-weight: 500;">{{ q['title'] }}</h6>
                                  </div>
                                </a>
                              </div>
                              <div class="d-flex align-items-center">
                                <div class="form-check">
                                  <input class="form-check-input question-star" type="checkbox" 
                                         id="star1-{{ q['id'] }}" 
                                         data-question-id="{{ q['id'] }}"
                                         data-folder-id="{{ f['id'] }}"
                                         data-star-type="star1"
                                         {% if q.get('star1') %}checked{% endif %}>
                                  <label class="form-check-label" for="star1-{{ q['id'] }}">
                                    <span class="star-icon">⭐</span>
                                  </label>
                                </div>
                                <div class="form-check">
                                  <input class="form-check-input question-star" type="checkbox" 
                                         id="star2-{{ q['id'] }}" 
                                         data-question-id="{{ q['id'] }}"
                                         data-folder-id="{{ f['id'] }}"
                                         data-star-type="star2"
                                         {% if q.get('star2') %}checked{% endif %}>
                                  <label class="form-check-label" for="star2-{{ q['id'] }}">
                                    <span class="star-icon">⭐</span>
                                  </label>
                                </div>
                                <div class="form-check">
                                  <input class="form-check-input question-star" type="checkbox" 
                                         id="star3-{{ q['id'] }}" 
                                         data-question-id="{{ q['id'] }}"
                                         data-folder-id="{{ f['id'] }}"
                                         data-star-type="star3"
                                         {% if q.get('star3') %}checked{% endif %}>
                                  <label class="form-check-label" for="star3-{{ q['id'] }}">
                                    <span class="star-icon">⭐</span>
                                  </label>
                                </div>
                              </div>
                            </div>
                          </div>
                        {% endfor %}
                      </div>
                    {% else %}
                      <div class="text-center py-3">
                        <p class="text-muted mb-0" style="font-size: 0.9rem;">No questions yet</p>
                      </div>
                    {% endif %}
                  </div>
                </div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="text-center py-5">
            <p class="text-muted mb-3" style="font-size: 1.1rem;">No folders yet.</p>
            <p class="text-muted mb-0" style="font-size: 0.9rem;">Click "Create Folder" to get started!</p>
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Create Folder Modal -->
<div class="modal fade" id="createFolderModal" tabindex="-1" aria-labelledby="createFolderModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="createFolderModalLabel">Create New Folder</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="post" action="{{ url_for('dashboard') }}">
        <div class="modal-body">
          <div class="mb-3">
            <label for="name" class="form-label">Folder Name</label>
            <input id="name" name="name" class="form-control" placeholder="e.g., Data Structures" required />
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-success">Create Folder</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Add Question Modal -->
<div class="modal fade" id="addQuestionModal" tabindex="-1" aria-labelledby="addQuestionModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addQuestionModalLabel">Add New Question</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="addQuestionForm" method="post" enctype="multipart/form-data">
        <div class="modal-body">
          <div class="row g-4">
            <div class="col-12 col-lg-6">
              <div class="mb-3">
                <label for="question-title" class="form-label">Que title (required)</label>
                <input id="question-title" name="title" class="form-control" placeholder="Enter your question title" required />
              </div>
              <div class="mb-3">
                <label for="question-description" class="form-label">Que description</label>
                <textarea id="question-description" name="description" class="form-control" rows="4" placeholder="Describe your question in detail (optional)"></textarea>
              </div>
              <div class="mb-3">
                <label for="question-links" class="form-label">Links (one per line)</label>
                <textarea id="question-links" name="links" class="form-control" rows="4" placeholder="Add reference links, one per line (optional)"></textarea>
              </div>
              <div class="mb-3">
                <label for="question-notes" class="form-label">Notes</label>
                <textarea id="question-notes" name="notes" class="form-control" rows="4" placeholder="Add any additional notes (optional)"></textarea>
              </div>
              <div class="mb-3">
                <label for="question-pdf" class="form-label">PDF File (optional)</label>
                <input type="file" id="question-pdf" name="pdf_file" class="form-control" accept=".pdf" />
                <div class="form-text">Upload a PDF file related to this question (max 10MB)</div>
              </div>
            </div>
            <div class="col-12 col-lg-6">
              <div class="mb-3">
                <label for="question-code" class="form-label">Code section</label>
                <textarea id="question-code" name="code" class="form-control" rows="12" placeholder="Paste your code here (optional)" style="font-family: 'Courier New', monospace;"></textarea>
              </div>
              <div class="mb-3">
                <label for="question-terminal" class="form-label">Terminal</label>
                <textarea id="question-terminal" name="terminal_output" class="form-control" rows="4" placeholder="Paste terminal output here (optional)" style="font-family: 'Courier New', monospace; background: #1a1a1a; color: var(--netflix-white);"></textarea>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-success">Add Question</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteModalLabel">Delete Folder</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete the folder "<span id="folderName"></span>"?</p>
        <p class="text-danger"><strong>Warning:</strong> This will permanently delete the folder and all questions inside it. This action cannot be undone.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <form id="deleteForm" method="post" style="display: inline;">
          <button type="submit" class="btn btn-danger">Delete Folder</button>
        </form>
      </div>
    </div>
  </div>
</div>

<style>
.delete-btn {
  border: none !important;
  background: linear-gradient(135deg, #28a745, #1e7e34) !important;
  color: white !important;
  border-radius: 6px !important;
  padding: 8px 10px !important;
  transition: all 0.3s ease !important;
  box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3) !important;
  position: relative;
  overflow: hidden;
}

.delete-btn:hover {
  background: linear-gradient(135deg, #34ce57, #28a745) !important;
  transform: translateY(-2px) !important;
  box-shadow: 0 4px 16px rgba(40, 167, 69, 0.4) !important;
  color: white !important;
}

.delete-btn:active {
  transform: translateY(0) !important;
  box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3) !important;
}

.delete-btn svg {
  transition: transform 0.2s ease;
}

.delete-btn:hover svg {
  transform: scale(1.1);
}

.delete-btn::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
  transition: left 0.5s;
}

.delete-btn:hover::before {
  left: 100%;
}

.card h2, .card h5 {
  color: var(--netflix-white) !important;
  font-weight: 600 !important;
}

.card h2 {
  font-size: 1.5rem !important;
  margin-bottom: 1rem !important;
}

.card h5 {
  font-size: 1.25rem !important;
  margin-bottom: 0.75rem !important;
}

.folder-item {
  border-radius: 8px !important;
  margin-bottom: 8px !important;
  transition: all 0.3s ease !important;
}

.folder-item:hover {
  background-color: var(--netflix-gray) !important;
  transform: translateY(-1px) !important;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2) !important;
}

.folder-name {
  color: var(--netflix-white) !important;
  font-weight: 600 !important;
  font-size: 1.1rem !important;
}

.folder-content {
  background-color: rgba(0, 0, 0, 0.2) !important;
  border-radius: 6px !important;
  padding: 12px !important;
  margin-top: 8px !important;
  border: 1px solid var(--netflix-border) !important;
}

.questions-list {
  max-height: 300px !important;
  overflow-y: auto !important;
}

.question-item {
  background-color: var(--netflix-card-bg) !important;
  border: 1px solid var(--netflix-border) !important;
  border-radius: 6px !important;
  padding: 12px !important;
  margin-bottom: 8px !important;
  transition: all 0.3s ease !important;
}

.question-item:hover {
  background-color: var(--netflix-gray) !important;
  transform: translateX(4px) !important;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2) !important;
}

.question-item:last-child {
  margin-bottom: 0 !important;
}

.dropdown-toggle {
  border: 1px solid var(--netflix-light-gray) !important;
  color: var(--netflix-light-gray) !important;
  background-color: transparent !important;
  transition: all 0.3s ease !important;
}

.dropdown-toggle:hover {
  background-color: var(--netflix-light-gray) !important;
  color: var(--netflix-white) !important;
  border-color: var(--netflix-light-gray) !important;
}

.dropdown-toggle[aria-expanded="true"] {
  background-color: var(--netflix-white) !important;
  border-color: var(--netflix-white) !important;
  color: var(--netflix-dark) !important;
}

.dropdown-toggle[aria-expanded="true"] svg {
  transform: rotate(180deg) !important;
}

.dropdown-toggle svg {
  transition: transform 0.3s ease !important;
}

.question-checkbox {
  width: 18px !important;
  height: 18px !important;
  border: 2px solid var(--netflix-light-gray) !important;
  border-radius: 4px !important;
  background-color: transparent !important;
  cursor: pointer !important;
  transition: all 0.3s ease !important;
  position: relative !important;
}

.question-checkbox:checked {
  background-color: var(--netflix-red) !important;
  border-color: var(--netflix-red) !important;
}

.question-checkbox:checked::after {
  content: "" !important;
  position: absolute !important;
  left: 6px !important;
  top: 2px !important;
  width: 4px !important;
  height: 8px !important;
  border: solid white !important;
  border-width: 0 2px 2px 0 !important;
  transform: rotate(45deg) !important;
}

.question-checkbox:hover {
  border-color: var(--netflix-red) !important;
  transform: scale(1.1) !important;
}

.form-check-label {
  cursor: pointer !important;
}

.progress-ring {
  transform: rotate(-90deg);
}

.progress-ring-circle {
  stroke-dasharray: 213.6;
  stroke-dashoffset: 213.6;
  transition: stroke-dashoffset 0.5s ease-in-out;
  stroke-linecap: round;
}

.progress-ring-circle-bg {
  stroke-linecap: round;
}

.question-star {
  width: 20px !important;
  height: 20px !important;
  margin: 0 !important;
  opacity: 0;
  position: absolute;
  cursor: pointer;
}

.star-icon {
  font-size: 18px;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  filter: grayscale(100%);
  opacity: 0.6;
}

.question-star:checked + .form-check-label .star-icon {
  filter: grayscale(0%);
  opacity: 1;
  transform: scale(1.2);
}

.star-icon:hover {
  transform: scale(1.1);
  opacity: 0.8;
}

/* Contribution Graph Styles */
.contribution-graph {
  display: flex;
  flex-wrap: wrap;
  gap: 2px;
  font-size: 10px;
  line-height: 1;
}

.contribution-day {
  width: 11px;
  height: 11px;
  border-radius: 2px;
  border: 1px solid rgba(255, 255, 255, 0.2);
  cursor: pointer;
  transition: all 0.2s ease;
}

.contribution-day:hover {
  transform: scale(1.2);
  z-index: 10;
  position: relative;
}

/* Contribution levels based on green gradient theme */
.contribution-level-0 { background-color: #161b22; } /* No contributions */
.contribution-level-1 { background-color: #0e4429; } /* 1 contribution */
.contribution-level-2 { background-color: #006d32; } /* 2-4 contributions */
.contribution-level-3 { background-color: #26a641; } /* 5-7 contributions */
.contribution-level-4 { background-color: #39d353; } /* 8-10 contributions */
.contribution-level-5 { background-color: #40c463; } /* 11-14 contributions */
.contribution-level-6 { background-color: #56d364; } /* 15-17 contributions */
.contribution-level-7 { background-color: #6bcf7a; } /* 18-21 contributions */
.contribution-level-8 { background-color: #7ee787; } /* 22+ contributions */

.contribution-tooltip {
  position: absolute;
  background: rgba(0, 0, 0, 0.8);
  color: white;
  padding: 8px 12px;
  border-radius: 6px;
  font-size: 12px;
  white-space: nowrap;
  z-index: 1000;
  pointer-events: none;
  transform: translate(-50%, -100%);
  margin-top: -8px;
}

.contribution-tooltip::after {
  content: '';
  position: absolute;
  top: 100%;
  left: 50%;
  transform: translateX(-50%);
  border: 4px solid transparent;
  border-top-color: rgba(0, 0, 0, 0.8);
}
</style>

<script>
function confirmDeleteFolder(folderId, folderName) {
  document.getElementById('folderName').textContent = folderName;
  document.getElementById('deleteForm').action = '/folders/' + folderId + '/delete';
  
  var deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
  deleteModal.show();
}

function openAddQuestionModal(folderId, folderName) {
  document.getElementById('addQuestionModalLabel').textContent = 'Add Question to "' + folderName + '"';
  document.getElementById('addQuestionForm').action = '/folders/' + folderId + '/add-question';
  
  // Clear form fields
  document.getElementById('question-title').value = '';
  document.getElementById('question-description').value = '';
  document.getElementById('question-notes').value = '';
  document.getElementById('question-links').value = '';
  document.getElementById('question-code').value = '';
  document.getElementById('question-terminal').value = '';
  
  var addQuestionModal = new bootstrap.Modal(document.getElementById('addQuestionModal'));
  addQuestionModal.show();
}

// Checkbox functionality
document.addEventListener('DOMContentLoaded', function() {
  const checkboxes = document.querySelectorAll('.question-checkbox');
  const starCheckboxes = document.querySelectorAll('.question-star');
  
  checkboxes.forEach(checkbox => {
    // Load saved state from localStorage
    const savedState = localStorage.getItem('question-' + checkbox.dataset.questionId);
    if (savedState === 'checked') {
      checkbox.checked = true;
    }
    
    // Add change event listener
    checkbox.addEventListener('change', function() {
      const questionId = this.dataset.questionId;
      const folderId = this.dataset.folderId;
      
      // Save state to localStorage
      if (this.checked) {
        localStorage.setItem('question-' + questionId, 'checked');
        console.log('Question ' + questionId + ' in folder ' + folderId + ' checked');
      } else {
        localStorage.removeItem('question-' + questionId);
        console.log('Question ' + questionId + ' in folder ' + folderId + ' unchecked');
      }
      
      // Update visual feedback
      updateQuestionItemState(this);
      
      // Update counter for this folder
      updateFolderCounter(folderId);
    });
  });
  
  // Star checkbox functionality
  starCheckboxes.forEach(starCheckbox => {
    // Load saved state from localStorage
    const questionId = starCheckbox.dataset.questionId;
    const starType = starCheckbox.dataset.starType;
    const savedStarState = localStorage.getItem('star-' + questionId + '-' + starType);
    if (savedStarState === 'checked') {
      starCheckbox.checked = true;
    }
    
    // Add event listener for star checkbox changes
    starCheckbox.addEventListener('change', function() {
      const questionId = this.dataset.questionId;
      const starType = this.dataset.starType;
      
      if (this.checked) {
        localStorage.setItem('star-' + questionId + '-' + starType, 'checked');
        console.log('Question ' + questionId + ' star ' + starType + ' checked');
      } else {
        localStorage.removeItem('star-' + questionId + '-' + starType);
        console.log('Question ' + questionId + ' star ' + starType + ' unchecked');
      }
    });
  });
  
  // Initialize counters for all folders
  initializeFolderCounters();
});

function updateFolderCounter(folderId) {
  const folderCheckboxes = document.querySelectorAll(`.question-checkbox[data-folder-id="${folderId}"]`);
  const checkedCount = document.querySelectorAll(`.question-checkbox[data-folder-id="${folderId}"]:checked`).length;
  const totalCount = folderCheckboxes.length;
  const counter = document.getElementById(`counter-${folderId}`);
  
  if (counter) {
    counter.textContent = `${checkedCount}/${totalCount}`;
    
    // Show counter if there are questions in the folder
    if (totalCount > 0) {
      counter.style.display = 'inline-block';
      
      // Change color based on completion percentage
      if (checkedCount === totalCount) {
        counter.className = 'checked-counter badge text-bg-success';
      } else if (checkedCount > totalCount / 2) {
        counter.className = 'checked-counter badge text-bg-warning';
      } else {
        counter.className = 'checked-counter badge text-bg-info';
      }
    } else {
      counter.style.display = 'none';
    }
  }
  
  // Update overall progress
  updateOverallProgress();
}

function updateOverallProgress() {
  const allCheckboxes = document.querySelectorAll('.question-checkbox');
  const totalChecked = document.querySelectorAll('.question-checkbox:checked').length;
  const totalQuestions = allCheckboxes.length;
  
  // Update progress text
  document.getElementById('progressText').textContent = `${totalChecked} / ${totalQuestions}`;
  
  // Calculate percentage
  const percentage = totalQuestions > 0 ? Math.round((totalChecked / totalQuestions) * 100) : 0;
  
  // Update circular progress bar
  const progressCircle = document.getElementById('progressCircle');
  const circumference = 2 * Math.PI * 34; // radius = 34
  const offset = circumference - (percentage / 100) * circumference;
  progressCircle.style.strokeDashoffset = offset;
  
  // Update percentage text
  document.getElementById('progressPercentage').textContent = `${percentage}%`;
  
  // Change progress circle color based on completion
  if (percentage === 100) {
    progressCircle.style.stroke = '#28a745'; // Green for complete
  } else if (percentage >= 75) {
    progressCircle.style.stroke = '#ffc107'; // Yellow for mostly complete
  } else if (percentage >= 50) {
    progressCircle.style.stroke = '#fd7e14'; // Orange for halfway
  } else {
    progressCircle.style.stroke = 'var(--netflix-red)'; // Red for less than half
  }
}

function initializeFolderCounters() {
  // Get all unique folder IDs
  const folderIds = [...new Set(Array.from(document.querySelectorAll('.question-checkbox')).map(cb => cb.dataset.folderId))];
  
  // Initialize counter for each folder
  folderIds.forEach(folderId => {
    updateFolderCounter(folderId);
  });
  
  // Initialize overall progress
  updateOverallProgress();
}

function updateQuestionItemState(checkbox) {
  const questionItem = checkbox.closest('.question-item');
  
  if (checkbox.checked) {
    questionItem.style.opacity = '0.7';
    questionItem.style.backgroundColor = 'rgba(229, 9, 20, 0.1)';
    questionItem.style.borderLeft = '4px solid var(--netflix-red)';
  } else {
    questionItem.style.opacity = '1';
    questionItem.style.backgroundColor = '';
    questionItem.style.borderLeft = '';
  }
}

// Function to get all checked questions (useful for future features)
function getCheckedQuestions() {
  const checkedQuestions = [];
  const checkboxes = document.querySelectorAll('.question-checkbox:checked');
  
  checkboxes.forEach(checkbox => {
    checkedQuestions.push({
      questionId: checkbox.dataset.questionId,
      folderId: checkbox.dataset.folderId
    });
  });
  
  return checkedQuestions;
}

// Function to clear all checkboxes
function clearAllCheckboxes() {
  const checkboxes = document.querySelectorAll('.question-checkbox');
  const folderIds = [...new Set(Array.from(checkboxes).map(cb => cb.dataset.folderId))];
  
  checkboxes.forEach(checkbox => {
    checkbox.checked = false;
    localStorage.removeItem('question-' + checkbox.dataset.questionId);
    updateQuestionItemState(checkbox);
  });
  
  // Update all folder counters
  folderIds.forEach(folderId => {
    updateFolderCounter(folderId);
  });
}

// Auto-save functionality with JWT error handling
function autoSaveCheckbox(questionId, isChecked) {
  fetch('/api/autosave/checkbox', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      question_id: questionId,
      checked: isChecked
    })
  })
  .then(response => {
    if (response.status === 401) {
      // JWT expired, redirect to login
      window.location.href = '/login';
      return;
    }
    return response.json();
  })
  .then(data => {
    if (data && data.success) {
      console.log('Checkbox auto-saved successfully');
    } else if (data) {
      console.error('Auto-save failed:', data.error);
    }
  })
  .catch(error => {
    console.error('Auto-save error:', error);
  });
}

function autoSaveStar(questionId, starType, isChecked) {
  fetch('/api/autosave/star', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      question_id: questionId,
      star_type: starType,
      checked: isChecked
    })
  })
  .then(response => {
    if (response.status === 401) {
      // JWT expired, redirect to login
      window.location.href = '/login';
      return;
    }
    return response.json();
  })
  .then(data => {
    if (data && data.success) {
      console.log('Star auto-saved successfully');
    } else if (data) {
      console.error('Auto-save failed:', data.error);
    }
  })
  .catch(error => {
    console.error('Auto-save error:', error);
  });
}

// Add event listeners for auto-save
document.addEventListener('DOMContentLoaded', function() {
  // Auto-save for question checkboxes
  document.addEventListener('change', function(e) {
    if (e.target.classList.contains('question-checkbox')) {
      const questionId = e.target.dataset.questionId;
      const isChecked = e.target.checked;
      
      // Update UI immediately
      updateQuestionItemState(e.target);
      updateFolderCounter(e.target.dataset.folderId);
      updateOverallProgress();
      
      // Auto-save to server
      autoSaveCheckbox(questionId, isChecked);
    }
    
    // Auto-save for star checkboxes
    if (e.target.classList.contains('question-star')) {
      const questionId = e.target.dataset.questionId;
      const starType = e.target.dataset.starType;
      const isChecked = e.target.checked;
      
      // Auto-save to server
      autoSaveStar(questionId, starType, isChecked);
    }
  });
  
  // Initialize folder counters
  initializeFolderCounters();
  
  // Load contribution graph
  loadContributionGraph();
});

// Contribution Graph Functions
function loadContributionGraph() {
  fetch('/api/contributions')
    .then(response => {
      if (response.status === 401) {
        // JWT expired, redirect to login
        window.location.href = '/login';
        return;
      }
      return response.json();
    })
    .then(data => {
      if (data && data.success) {
        renderContributionGraph(data.data);
      } else if (data) {
        console.error('Failed to load contributions:', data.error);
      }
    })
    .catch(error => {
      console.error('Error loading contributions:', error);
    });
}

function renderContributionGraph(contributions) {
  const graphContainer = document.getElementById('contributionGraph');
  const totalContributions = contributions.reduce((sum, day) => sum + day.count, 0);
  
  // Update total contributions text
  document.getElementById('totalContributions').textContent = totalContributions;
  
  // Clear existing content
  graphContainer.innerHTML = '';
  
  // Group contributions by weeks (7 days each)
  const weeks = [];
  for (let i = 0; i < contributions.length; i += 7) {
    weeks.push(contributions.slice(i, i + 7));
  }
  
  // Create the graph
  weeks.forEach((week, weekIndex) => {
    const weekContainer = document.createElement('div');
    weekContainer.style.display = 'flex';
    weekContainer.style.flexDirection = 'column';
    weekContainer.style.gap = '2px';
    
    week.forEach((day, dayIndex) => {
      const dayElement = document.createElement('div');
      dayElement.className = `contribution-day contribution-level-${day.level}`;
      dayElement.title = formatTooltip(day);
      
      // Add hover effect
      dayElement.addEventListener('mouseenter', function(e) {
        showTooltip(e, day);
      });
      
      dayElement.addEventListener('mouseleave', function() {
        hideTooltip();
      });
      
      weekContainer.appendChild(dayElement);
    });
    
    graphContainer.appendChild(weekContainer);
  });
}

function formatTooltip(day) {
  const date = new Date(day.date);
  const dateStr = date.toLocaleDateString('en-US', { 
    weekday: 'long', 
    year: 'numeric', 
    month: 'long', 
    day: 'numeric' 
  });
  
  if (day.count === 0) {
    return `${dateStr}: No contributions`;
  } else if (day.count === 1) {
    return `${dateStr}: 1 contribution`;
  } else {
    return `${dateStr}: ${day.count} contributions`;
  }
}

function showTooltip(event, day) {
  const tooltip = document.createElement('div');
  tooltip.className = 'contribution-tooltip';
  tooltip.textContent = formatTooltip(day);
  
  document.body.appendChild(tooltip);
  
  const rect = event.target.getBoundingClientRect();
  tooltip.style.left = rect.left + rect.width / 2 + 'px';
  tooltip.style.top = rect.top + 'px';
}

function hideTooltip() {
  const tooltip = document.querySelector('.contribution-tooltip');
  if (tooltip) {
    tooltip.remove();
  }
}
</script>
{% endblock %}
